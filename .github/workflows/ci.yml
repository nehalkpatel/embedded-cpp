name: CI

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  format-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run clang-format check
        run: |
          find src \( -name '*.cpp' -o -name '*.hpp' \) -print0 | xargs -0 clang-format --dry-run --Werror

  build-host:
    name: Build (Host - Linux)
    runs-on: ubuntu-latest
    needs: format-check
    strategy:
      matrix:
        config: [Debug, Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            libc++-dev \
            libc++abi-dev \
            cmake \
            ninja-build \
            libzmq3-dev

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r py/host-emulator/requirements.txt

      - name: Configure CMake
        run: cmake --preset=host
        env:
          CMAKE_TOOLCHAIN_PATH: /usr

      - name: Build
        run: cmake --build --preset=host --config ${{ matrix.config }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: host-build-${{ matrix.config }}
          path: |
            build/host/bin/*
          retention-days: 7

  test-unit:
    name: Unit Tests (C++)
    runs-on: ubuntu-latest
    needs: build-host
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            libc++-dev \
            libc++abi-dev \
            cmake \
            ninja-build \
            libzmq3-dev

      - name: Configure CMake
        run: cmake --preset=host
        env:
          CMAKE_TOOLCHAIN_PATH: /usr

      - name: Build
        run: cmake --build --preset=host --config Debug

      - name: Run CTest
        run: ctest --preset=host -C Debug --output-on-failure --verbose
        working-directory: .

  test-integration:
    name: Integration Tests (Python)
    runs-on: ubuntu-latest
    needs: build-host
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            libc++-dev \
            libc++abi-dev \
            cmake \
            ninja-build \
            libzmq3-dev

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r py/host-emulator/requirements.txt

      - name: Configure CMake
        run: cmake --preset=host
        env:
          CMAKE_TOOLCHAIN_PATH: /usr

      - name: Build
        run: cmake --build --preset=host --config Debug

      - name: Run pytest with coverage
        run: |
          cd py/host-emulator
          pytest tests/ \
            --blinky=../../build/host/bin/blinky \
            --cov=src \
            --cov-report=xml \
            --cov-report=term \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./py/host-emulator/coverage.xml
          flags: integration-tests
          name: integration-coverage
        continue-on-error: true

  build-arm-cm4:
    name: Build (ARM Cortex-M4)
    runs-on: ubuntu-latest
    needs: format-check
    if: false  # Disabled until ARM toolchain is properly configured
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi

      - name: Install build dependencies
        run: |
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake
        run: cmake --preset=arm-cm4
        env:
          CMAKE_TOOLCHAIN_PATH: /usr

      - name: Build
        run: cmake --build --preset=arm-cm4 --config Release

  build-stm32f3:
    name: Build (STM32F3 Discovery)
    runs-on: ubuntu-latest
    needs: format-check
    if: false  # Disabled until board implementation is complete
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi

      - name: Install build dependencies
        run: |
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake
        run: cmake --preset=stm32f3_discovery
        env:
          CMAKE_TOOLCHAIN_PATH: /usr

      - name: Build
        run: cmake --build --preset=stm32f3_discovery --config Release

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [format-check, build-host, test-unit, test-integration]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Format Check: ${{ needs.format-check.result }}"
          echo "Build Host: ${{ needs.build-host.result }}"
          echo "Unit Tests: ${{ needs.test-unit.result }}"
          echo "Integration Tests: ${{ needs.test-integration.result }}"

          if [ "${{ needs.format-check.result }}" != "success" ] || \
             [ "${{ needs.build-host.result }}" != "success" ] || \
             [ "${{ needs.test-unit.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "❌ CI pipeline failed"
            exit 1
          fi

          echo "✅ All CI checks passed"
