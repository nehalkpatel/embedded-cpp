name: CI

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: embedded-cpp:ci

jobs:
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          tags: ${{ env.DOCKER_IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Save Docker image
        run: docker save ${{ env.DOCKER_IMAGE }} | gzip > docker-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 1

  format-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar.gz

      - name: Run clang-format check
        run: |
          docker run --rm -v $(pwd):/workspace ${{ env.DOCKER_IMAGE }} \
            bash -c "find src \( -name '*.cpp' -o -name '*.hpp' \) -print0 | xargs -0 clang-format --dry-run --Werror"

  build-host:
    name: Build (Host - Linux)
    runs-on: ubuntu-latest
    needs: build-docker
    strategy:
      matrix:
        config: [Debug, Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar.gz

      - name: Build
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace ${{ env.DOCKER_IMAGE }} \
            bash -c "cmake --preset=host && cmake --build --preset=host --config ${{ matrix.config }}"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: host-build-${{ matrix.config }}
          path: |
            build/host/bin/*
          retention-days: 7

  test-unit:
    name: Unit Tests (C++)
    runs-on: ubuntu-latest
    needs: build-host
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar.gz

      - name: Build and test
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace ${{ env.DOCKER_IMAGE }} \
            bash -c "cmake --preset=host && cmake --build --preset=host --config Debug && ctest --preset=host -C Debug --output-on-failure --verbose"

  test-integration:
    name: Integration Tests (Python)
    runs-on: ubuntu-latest
    needs: build-host
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar.gz

      - name: Build and run integration tests
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace ${{ env.DOCKER_IMAGE }} \
            bash -c "
              cmake --preset=host &&
              cmake --build --preset=host --config Debug &&
              cd py/host-emulator &&
              pip install -r requirements.txt &&
              pytest tests/ --blinky=../../build/host/bin/blinky --cov=src --cov-report=xml --cov-report=term -v
            "

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./py/host-emulator/coverage.xml
          flags: integration-tests
          name: integration-coverage
        continue-on-error: true

  build-arm-cm4:
    name: Build (ARM Cortex-M4)
    runs-on: ubuntu-latest
    needs: build-docker
    if: false  # Disabled until ARM toolchain is properly configured
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar.gz

      - name: Build
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace ${{ env.DOCKER_IMAGE }} \
            bash -c "cmake --preset=arm-cm4 && cmake --build --preset=arm-cm4 --config Release"

  build-stm32f3:
    name: Build (STM32F3 Discovery)
    runs-on: ubuntu-latest
    needs: build-docker
    if: false  # Disabled until board implementation is complete
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < docker-image.tar.gz

      - name: Build
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace ${{ env.DOCKER_IMAGE }} \
            bash -c "cmake --preset=stm32f3_discovery && cmake --build --preset=stm32f3_discovery --config Release"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [format-check, build-host, test-unit, test-integration]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Format Check: ${{ needs.format-check.result }}"
          echo "Build Host: ${{ needs.build-host.result }}"
          echo "Unit Tests: ${{ needs.test-unit.result }}"
          echo "Integration Tests: ${{ needs.test-integration.result }}"

          if [ "${{ needs.format-check.result }}" != "success" ] || \
             [ "${{ needs.build-host.result }}" != "success" ] || \
             [ "${{ needs.test-unit.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "❌ CI pipeline failed"
            exit 1
          fi

          echo "✅ All CI checks passed"
